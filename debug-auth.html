<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auth Debug - Tumblera</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">üîç Authentication Debug Tool</h1>
        
        <div id="results" class="space-y-4">
            <div class="bg-white p-4 rounded shadow">
                <p class="text-gray-600">Loading authentication status...</p>
            </div>
        </div>

        <div class="mt-6">
            <button onclick="checkAuth()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
                üîÑ Refresh Check
            </button>
            <a href="seller.html" class="ml-4 bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 inline-block">
                ‚Üí Try Seller Dashboard
            </a>
        </div>
    </div>

    <script type="module">
        import { supabase, getCurrentUser, isSeller } from './js/supabase.js';

        async function checkAuth() {
            const results = document.getElementById('results');
            results.innerHTML = '<div class="bg-white p-4 rounded shadow"><p class="text-gray-600">Checking...</p></div>';

            try {
                // Check 1: Get session
                const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                
                // Check 2: Get user
                const { data: { user }, error: userError } = await supabase.auth.getUser();
                
                // Check 3: Get user profile from database
                let userProfile = null;
                let profileError = null;
                if (user) {
                    const { data, error } = await supabase
                        .from('users')
                        .select('*')
                        .eq('id', user.id)
                        .single();
                    userProfile = data;
                    profileError = error;
                }

                // Check 4: Check if seller
                let isSellerResult = false;
                if (user) {
                    isSellerResult = await isSeller(user.id);
                }

                // Display results
                results.innerHTML = `
                    <div class="bg-white p-6 rounded shadow space-y-4">
                        <h2 class="text-xl font-bold mb-4">Authentication Status</h2>
                        
                        <!-- Session -->
                        <div class="border-b pb-4">
                            <h3 class="font-semibold mb-2">1. Session Status</h3>
                            <p class="text-sm ${session ? 'text-green-600' : 'text-red-600'}">
                                ${session ? '‚úÖ Active Session' : '‚ùå No Active Session'}
                            </p>
                            ${sessionError ? `<p class="text-red-600 text-sm">Error: ${sessionError.message}</p>` : ''}
                        </div>

                        <!-- User -->
                        <div class="border-b pb-4">
                            <h3 class="font-semibold mb-2">2. Current User (Auth)</h3>
                            ${user ? `
                                <p class="text-sm text-green-600">‚úÖ Authenticated</p>
                                <div class="mt-2 text-sm bg-gray-50 p-2 rounded">
                                    <p><strong>ID:</strong> ${user.id}</p>
                                    <p><strong>Email:</strong> ${user.email}</p>
                                    <p><strong>Created:</strong> ${new Date(user.created_at).toLocaleString()}</p>
                                </div>
                            ` : `
                                <p class="text-sm text-red-600">‚ùå Not Authenticated</p>
                            `}
                            ${userError ? `<p class="text-red-600 text-sm">Error: ${userError.message}</p>` : ''}
                        </div>

                        <!-- User Profile -->
                        <div class="border-b pb-4">
                            <h3 class="font-semibold mb-2">3. User Profile (Database)</h3>
                            ${userProfile ? `
                                <p class="text-sm text-green-600">‚úÖ Profile Found</p>
                                <div class="mt-2 text-sm bg-gray-50 p-2 rounded">
                                    <p><strong>ID:</strong> ${userProfile.id}</p>
                                    <p><strong>Email:</strong> ${userProfile.email}</p>
                                    <p><strong>Role:</strong> <span class="font-bold ${userProfile.role === 'seller' ? 'text-purple-600' : 'text-blue-600'}">${userProfile.role?.toUpperCase()}</span></p>
                                    <p><strong>First Name:</strong> ${userProfile.first_name || 'N/A'}</p>
                                    <p><strong>Last Name:</strong> ${userProfile.last_name || 'N/A'}</p>
                                    <p><strong>Phone:</strong> ${userProfile.phone || 'N/A'}</p>
                                </div>
                            ` : `
                                <p class="text-sm text-red-600">‚ùå Profile Not Found</p>
                                <p class="text-xs text-gray-600 mt-2">Run the trigger SQL from SUPABASE_SETUP.md Step 3.3</p>
                            `}
                            ${profileError ? `<p class="text-red-600 text-sm">Error: ${profileError.message}</p>` : ''}
                        </div>

                        <!-- Seller Check -->
                        <div class="pb-4">
                            <h3 class="font-semibold mb-2">4. Seller Access</h3>
                            <p class="text-sm ${isSellerResult ? 'text-green-600' : 'text-red-600'}">
                                ${isSellerResult ? '‚úÖ Has Seller Access' : '‚ùå No Seller Access'}
                            </p>
                            ${userProfile && userProfile.role !== 'seller' && userProfile.role !== 'admin' ? `
                                <div class="mt-2 p-3 bg-yellow-50 border border-yellow-200 rounded">
                                    <p class="text-sm text-yellow-800">
                                        <strong>‚ö†Ô∏è Action Required:</strong> Change role to "seller" in Supabase Dashboard
                                    </p>
                                    <ol class="text-xs text-yellow-700 mt-2 ml-4 list-decimal">
                                        <li>Go to Supabase Dashboard</li>
                                        <li>Table Editor ‚Üí users</li>
                                        <li>Find your email: ${userProfile.email}</li>
                                        <li>Change role from "${userProfile.role}" to "seller"</li>
                                        <li>Save and refresh this page</li>
                                    </ol>
                                </div>
                            ` : ''}
                        </div>

                        <!-- Recommendation -->
                        <div class="mt-6 p-4 ${isSellerResult ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'} border rounded">
                            <h3 class="font-semibold mb-2">üìã Status Summary</h3>
                            ${!user ? `
                                <p class="text-sm">‚ùå You need to <a href="login.html" class="text-blue-600 underline">login</a> first</p>
                            ` : !userProfile ? `
                                <p class="text-sm">‚ùå User profile not found in database. Run the trigger SQL from SUPABASE_SETUP.md</p>
                            ` : !isSellerResult ? `
                                <p class="text-sm">‚ùå You are logged in as "${userProfile.role}". Change role to "seller" in Supabase to access seller dashboard.</p>
                            ` : `
                                <p class="text-sm text-green-700">‚úÖ All checks passed! You should be able to access the seller dashboard.</p>
                                <a href="seller.html" class="mt-2 inline-block bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                                    ‚Üí Go to Seller Dashboard
                                </a>
                            `}
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Debug error:', error);
                results.innerHTML = `
                    <div class="bg-red-50 border border-red-200 p-4 rounded">
                        <p class="text-red-800 font-semibold">Error running debug check:</p>
                        <p class="text-red-700 text-sm mt-2">${error.message}</p>
                        <p class="text-xs text-gray-600 mt-2">Check browser console for more details</p>
                    </div>
                `;
            }
        }

        // Make function global
        window.checkAuth = checkAuth;

        // Run on load
        checkAuth();
    </script>
</body>
</html>
